name: Release App Bundle
on:
  push:
    tags:
      - 'v*'

jobs:
  # ------------------------------------------------------------------
  # 1. Build for Windows (x64 only for now)
  # ------------------------------------------------------------------
  build-windows-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'oracle'
          architecture: x64

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Zip)
        run: |
          cd app/build/dist
          Compress-Archive -Path platformer -DestinationPath platformer-windows-x64.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-windows-x64
          path: app/build/dist/platformer-windows-x64.zip

  # ------------------------------------------------------------------
  # 2. Build for Ubuntu (x64)
  # ------------------------------------------------------------------
  build-ubuntu-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'oracle'
          architecture: x64
      
      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Tar)
        run: |
          cd app/build/dist
          tar -czvf platformer-ubuntu-x64.tar.gz platformer

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-ubuntu-x64
          path: app/build/dist/platformer-ubuntu-x64.tar.gz

  # ------------------------------------------------------------------
  # 3. Build for Ubuntu (ARM64)
  # ------------------------------------------------------------------
  build-ubuntu-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'oracle'
          architecture: aarch64
      
      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Tar)
        run: |
          cd app/build/dist
          tar -czvf platformer-ubuntu-arm64.tar.gz platformer

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-ubuntu-arm64
          path: app/build/dist/platformer-ubuntu-arm64.tar.gz

  # ------------------------------------------------------------------
  # 4. Build for MacOS (x64 / Intel)
  # ------------------------------------------------------------------
  build-macos-x64:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'oracle'
          architecture: x64
      
      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Zip)
        run: |
          cd app/build/dist
          zip -r platformer-macos-x64.zip platformer.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-macos-x64
          path: app/build/dist/platformer-macos-x64.zip

  # ------------------------------------------------------------------
  # 5. Build for MacOS (ARM64 / Apple Silicon)
  # ------------------------------------------------------------------
  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'oracle'
          architecture: aarch64
      
      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Zip)
        run: |
          cd app/build/dist
          zip -r platformer-macos-arm64.zip platformer.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-macos-arm64
          path: app/build/dist/platformer-macos-arm64.zip

  # ------------------------------------------------------------------
  # 6. Build for Oracle Linux (x64)
  # ------------------------------------------------------------------
  build-oracle-linux-x64:
    runs-on: ubuntu-latest
    container: oraclelinux:9
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          dnf update -y
          dnf install -y java-21-openjdk-devel java-21-openjdk-jmods tar gzip binutils findutils

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Tar)
        run: |
          cd app/build/dist
          tar -czvf platformer-oracle-linux-x64.tar.gz platformer

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-oracle-linux-x64
          path: app/build/dist/platformer-oracle-linux-x64.tar.gz

  # ------------------------------------------------------------------
  # 7. Build for Oracle Linux (ARM64)
  # ------------------------------------------------------------------
  build-oracle-linux-arm64:
    runs-on: ubuntu-24.04-arm
    container: oraclelinux:9
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          dnf update -y
          dnf install -y java-21-openjdk-devel java-21-openjdk-jmods tar gzip binutils findutils

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build with JPackage
        run: ./gradlew jpackage

      - name: Archive Bundle (Tar)
        run: |
          cd app/build/dist
          tar -czvf platformer-oracle-linux-arm64.tar.gz platformer

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platformer-oracle-linux-arm64
          path: app/build/dist/platformer-oracle-linux-arm64.tar.gz

  # ------------------------------------------------------------------
  # 8. Create GitHub Release
  # ------------------------------------------------------------------
  release:
    needs: 
      - build-windows-x64
      - build-ubuntu-x64
      - build-ubuntu-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-oracle-linux-x64
      - build-oracle-linux-arm64
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-windows-x64
          path: artifacts/windows-x64

      - name: Download Ubuntu x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-ubuntu-x64
          path: artifacts/ubuntu-x64

      - name: Download Ubuntu ARM64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-ubuntu-arm64
          path: artifacts/ubuntu-arm64

      - name: Download MacOS x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-macos-x64
          path: artifacts/macos-x64

      - name: Download MacOS ARM64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-macos-arm64
          path: artifacts/macos-arm64

      - name: Download Oracle Linux x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-oracle-linux-x64
          path: artifacts/oracle-x64

      - name: Download Oracle Linux ARM64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: platformer-oracle-linux-arm64
          path: artifacts/oracle-arm64

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-x64/platformer-windows-x64.zip
            artifacts/ubuntu-x64/platformer-ubuntu-x64.tar.gz
            artifacts/ubuntu-arm64/platformer-ubuntu-arm64.tar.gz
            artifacts/macos-x64/platformer-macos-x64.zip
            artifacts/macos-arm64/platformer-macos-arm64.zip
            artifacts/oracle-x64/platformer-oracle-linux-x64.tar.gz
            artifacts/oracle-arm64/platformer-oracle-linux-arm64.tar.gz
